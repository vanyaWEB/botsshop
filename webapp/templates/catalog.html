{% extends "base.html" %}

{% block title %}Каталог - Магазин одежды{% endblock %}

{% block styles %}
<style>
    /* Полностью переработанный современный дизайн каталога */
    
    /* Анимации */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes scaleIn {
        from {
            opacity: 0;
            transform: scale(0.9);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    @keyframes shimmer {
        0% {
            background-position: -1000px 0;
        }
        100% {
            background-position: 1000px 0;
        }
    }

    /* Заголовок каталога */
    .catalog-header {
        margin-bottom: 2rem;
        animation: fadeInUp 0.6s ease-out;
    }

    .catalog-title {
        font-size: clamp(2rem, 6vw, 3rem);
        font-weight: 900;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
        letter-spacing: -0.02em;
    }

    .catalog-subtitle {
        color: var(--text-secondary);
        font-size: 1.1rem;
        margin-bottom: 2rem;
    }

    /* Поиск с современным дизайном */
    .search-container {
        position: relative;
        margin-bottom: 2rem;
        animation: fadeInUp 0.6s ease-out 0.1s both;
    }

    .search-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .search-icon {
        position: absolute;
        left: 1.25rem;
        color: var(--text-secondary);
        font-size: 1.25rem;
        pointer-events: none;
        z-index: 1;
    }

    .search-input {
        width: 100%;
        padding: 1.25rem 1.25rem 1.25rem 3.5rem;
        border: 2px solid var(--border);
        border-radius: 1.25rem;
        background: var(--surface);
        color: var(--text);
        font-size: 1rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 4px 20px rgba(99, 102, 241, 0.15);
        transform: translateY(-2px);
    }

    .search-input::placeholder {
        color: var(--text-secondary);
    }

    /* Фильтры */
    .filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        animation: fadeInUp 0.6s ease-out 0.2s both;
    }

    .filter-select {
        flex: 1;
        min-width: 160px;
        padding: 1rem 1.25rem;
        border: 2px solid var(--border);
        border-radius: 1rem;
        background: var(--surface);
        color: var(--text);
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .filter-select:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 4px 20px rgba(99, 102, 241, 0.15);
    }

    /* Категории с улучшенным дизайном */
    .categories {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 1rem;
        margin-bottom: 2.5rem;
    }

    .category-btn {
        background: var(--surface);
        border: 2px solid var(--border);
        padding: 1.5rem 1rem;
        border-radius: 1.25rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-align: center;
        font-weight: 700;
        color: var(--text);
        min-height: 120px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        animation: scaleIn 0.4s ease-out;
        animation-fill-mode: both;
    }

    .category-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        opacity: 0;
        transition: opacity 0.3s;
    }

    .category-btn:hover {
        transform: translateY(-4px) scale(1.02);
        box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2);
        border-color: var(--primary);
    }

    .category-btn.active {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border-color: transparent;
        box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
        transform: translateY(-2px);
    }

    .category-btn.active::before {
        opacity: 1;
    }

    .category-icon {
        font-size: 2.5rem;
        position: relative;
        z-index: 1;
        transition: transform 0.3s;
    }

    .category-btn:hover .category-icon {
        transform: scale(1.1) rotate(5deg);
    }

    .category-name {
        font-size: 1rem;
        position: relative;
        z-index: 1;
    }

    .category-count {
        font-size: 0.8rem;
        opacity: 0.9;
        position: relative;
        z-index: 1;
    }

    /* Сетка товаров с улучшенным дизайном */
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1.5rem;
    }

    .product-card {
        background: var(--surface);
        border-radius: 1.5rem;
        overflow: hidden;
        border: 2px solid var(--border);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        position: relative;
        animation: scaleIn 0.5s ease-out;
        animation-fill-mode: both;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .product-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 12px 32px rgba(99, 102, 241, 0.2);
        border-color: var(--primary);
    }

    .product-image-wrapper {
        position: relative;
        width: 100%;
        aspect-ratio: 1;
        overflow: hidden;
        background: linear-gradient(
            90deg,
            var(--border) 0%,
            var(--surface) 50%,
            var(--border) 100%
        );
        background-size: 200% 100%;
    }

    .product-image-wrapper.loading {
        animation: shimmer 1.5s infinite;
    }

    .product-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .product-card:hover .product-image {
        transform: scale(1.1);
    }

    .product-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: var(--primary);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        font-size: 0.8rem;
        font-weight: 700;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        z-index: 1;
    }

    .product-badge.out-of-stock {
        background: var(--error);
    }

    .product-info {
        padding: 1.25rem;
    }

    .product-name {
        font-size: 1.1rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        color: var(--text);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.4;
    }

    .product-description {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 1rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.5;
    }

    .product-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border);
    }

    .product-price {
        font-size: 1.5rem;
        font-weight: 900;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .product-stock {
        font-size: 0.85rem;
        color: var(--success);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .product-stock.out {
        color: var(--error);
    }

    /* Модальное окно с улучшенным дизайном */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(8px);
        z-index: 1000;
        padding: 0;
        overflow-y: auto;
    }

    .modal.active {
        display: flex;
        align-items: flex-end;
        animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-content {
        background: var(--background);
        border-radius: 2rem 2rem 0 0;
        width: 100%;
        max-height: 92vh;
        overflow-y: auto;
        animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.2);
    }

    @keyframes slideUp {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 2px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        background: var(--background);
        z-index: 10;
        backdrop-filter: blur(10px);
    }

    .modal-title {
        font-size: 1.5rem;
        font-weight: 900;
        flex: 1;
        padding-right: 1rem;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .modal-close {
        background: var(--surface);
        border: 2px solid var(--border);
        width: 44px;
        height: 44px;
        border-radius: 50%;
        cursor: pointer;
        color: var(--text);
        font-size: 1.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.3s;
        font-weight: 300;
    }

    .modal-close:hover {
        background: var(--error);
        color: white;
        border-color: var(--error);
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 1.5rem;
    }

    /* Карусель изображений */
    .image-carousel {
        position: relative;
        width: 100%;
        aspect-ratio: 1;
        overflow: hidden;
        border-radius: 1.5rem;
        margin-bottom: 1.5rem;
        background: var(--surface);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    }

    .carousel-images {
        display: flex;
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        height: 100%;
    }

    .carousel-image {
        min-width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .carousel-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.95);
        color: var(--primary);
        border: none;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.3s;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        font-size: 1.5rem;
        font-weight: 700;
    }

    .carousel-btn:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-50%) scale(1.1);
    }

    .carousel-btn.prev {
        left: 1rem;
    }

    .carousel-btn.next {
        right: 1rem;
    }

    .carousel-indicators {
        position: absolute;
        bottom: 1rem;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 0.5rem;
        background: rgba(0, 0, 0, 0.3);
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        backdrop-filter: blur(10px);
    }

    .carousel-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
        cursor: pointer;
        transition: all 0.3s;
    }

    .carousel-indicator.active {
        background: white;
        width: 32px;
        border-radius: 5px;
    }

    /* Селектор размеров */
    .size-section {
        margin: 1.5rem 0;
    }

    .size-label {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--text);
    }

    .size-selector {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        gap: 0.75rem;
    }

    .size-btn {
        padding: 1rem;
        border: 2px solid var(--border);
        background: var(--surface);
        border-radius: 1rem;
        cursor: pointer;
        font-weight: 700;
        font-size: 1rem;
        transition: all 0.3s;
        min-height: 56px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .size-btn:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
    }

    .size-btn.selected {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border-color: transparent;
        box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
    }

    /* Кнопка добавления в корзину */
    .add-to-cart-btn {
        width: 100%;
        padding: 1.25rem;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        border: none;
        border-radius: 1.25rem;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 1.5rem;
        box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
    }

    .add-to-cart-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 32px rgba(99, 102, 241, 0.4);
    }

    .add-to-cart-btn:active {
        transform: translateY(0);
    }

    /* Пустое состояние */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--text-secondary);
        animation: fadeInUp 0.6s ease-out;
    }

    .empty-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-text {
        font-size: 1.2rem;
        font-weight: 600;
    }

    /* Результаты поиска */
    .search-results {
        position: absolute;
        top: calc(100% + 0.5rem);
        left: 0;
        right: 0;
        background: var(--surface);
        border: 2px solid var(--border);
        border-radius: 1.25rem;
        max-height: 400px;
        overflow-y: auto;
        z-index: 100;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
        display: none;
    }

    .search-results.active {
        display: block;
        animation: scaleIn 0.3s ease-out;
    }

    .search-result-item {
        padding: 1rem;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .search-result-item:hover {
        background: var(--background);
        padding-left: 1.5rem;
    }

    .search-result-image {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 0.75rem;
        flex-shrink: 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .search-result-info {
        flex: 1;
        min-width: 0;
    }

    .search-result-name {
        font-weight: 700;
        font-size: 1rem;
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .search-result-category {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .search-result-price {
        font-weight: 800;
        color: var(--primary);
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    /* Toast уведомления */
    .toast {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        background: var(--surface);
        color: var(--text);
        padding: 1rem 1.5rem;
        border-radius: 1rem;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        z-index: 2000;
        animation: slideIn 0.3s ease-out;
        border: 2px solid var(--border);
        font-weight: 600;
        max-width: 90%;
    }

    .toast.success {
        border-color: var(--success);
        background: var(--success);
        color: white;
    }

    .toast.error {
        border-color: var(--error);
        background: var(--error);
        color: white;
    }

    @keyframes slideIn {
        from {
            transform: translateX(-50%) translateY(100px);
            opacity: 0;
        }
        to {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    }

    /* Адаптивность */
    @media (min-width: 481px) and (max-width: 768px) {
        .products-grid {
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        }

        .categories {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }

        .modal.active {
            align-items: center;
            padding: 1rem;
        }

        .modal-content {
            border-radius: 2rem;
            max-width: 600px;
        }
    }

    @media (min-width: 769px) {
        .products-grid {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
        }

        .categories {
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1.25rem;
        }

        .modal.active {
            align-items: center;
            padding: 2rem;
        }

        .modal-content {
            border-radius: 2rem;
            max-width: 800px;
            max-height: 90vh;
        }
    }

    /* Анимация появления карточек с задержкой */
    .product-card:nth-child(1) { animation-delay: 0.05s; }
    .product-card:nth-child(2) { animation-delay: 0.1s; }
    .product-card:nth-child(3) { animation-delay: 0.15s; }
    .product-card:nth-child(4) { animation-delay: 0.2s; }
    .product-card:nth-child(5) { animation-delay: 0.25s; }
    .product-card:nth-child(6) { animation-delay: 0.3s; }

    .category-btn:nth-child(1) { animation-delay: 0.05s; }
    .category-btn:nth-child(2) { animation-delay: 0.1s; }
    .category-btn:nth-child(3) { animation-delay: 0.15s; }
    .category-btn:nth-child(4) { animation-delay: 0.2s; }
    .category-btn:nth-child(5) { animation-delay: 0.25s; }
</style>
{% endblock %}

{% block content %}
<div class="catalog-header">
    <h1 class="catalog-title">Каталог товаров</h1>
    <p class="catalog-subtitle">Найдите идеальную одежду для себя</p>

    <div class="search-container">
        <div class="search-wrapper">
            <span class="search-icon">🔍</span>
            <input 
                type="text" 
                class="search-input" 
                id="searchInput" 
                placeholder="Поиск по названию, категории..."
                autocomplete="off"
            >
        </div>
        <div class="search-results" id="searchResults"></div>
    </div>

    <div class="filters">
        <select class="filter-select" id="sortFilter" aria-label="Сортировка">
            <option value="">📊 Сортировка</option>
            <option value="price_asc">💰 Цена: по возрастанию</option>
            <option value="price_desc">💎 Цена: по убыванию</option>
            <option value="name_asc">🔤 Название: А-Я</option>
            <option value="name_desc">🔤 Название: Я-А</option>
        </select>

        <select class="filter-select" id="stockFilter" aria-label="Наличие">
            <option value="">📦 Все товары</option>
            <option value="in_stock">✅ В наличии</option>
            <option value="out_of_stock">❌ Нет в наличии</option>
        </select>
    </div>
</div>

<div id="categories" class="categories">
    <div class="loading">
        <div class="spinner"></div>
        <span>Загрузка категорий...</span>
    </div>
</div>

<div id="products" class="products-grid">
    <div class="loading">
        <div class="spinner"></div>
        <span>Загрузка товаров...</span>
    </div>
</div>

<div id="productModal" class="modal" onclick="if(event.target === this) closeModal()">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modalProductName"></h2>
            <button class="modal-close" onclick="closeModal()" aria-label="Закрыть">&times;</button>
        </div>
        <div class="modal-body">
            <div class="image-carousel" id="imageCarousel">
                <div class="carousel-images" id="carouselImages"></div>
                <button class="carousel-btn prev" onclick="prevImage(); event.stopPropagation();" aria-label="Предыдущее">‹</button>
                <button class="carousel-btn next" onclick="nextImage(); event.stopPropagation();" aria-label="Следующее">›</button>
                <div class="carousel-indicators" id="carouselIndicators"></div>
            </div>

            <div>
                <p id="modalProductDescription" style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 1rem; line-height: 1.6;"></p>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; padding: 1.25rem; background: var(--surface); border-radius: 1.25rem; border: 2px solid var(--border);">
                    <div style="font-size: 2rem; font-weight: 900;" id="modalProductPrice"></div>
                    <div id="modalProductStock" style="padding: 0.5rem 1rem; border-radius: 2rem; font-weight: 700; font-size: 0.9rem;"></div>
                </div>

                <div id="sizeSection" class="size-section" style="display: none;">
                    <div class="size-label">Выберите размер:</div>
                    <div id="sizeSelector" class="size-selector"></div>
                </div>

                <button class="add-to-cart-btn" onclick="addToCart()">
                    <span style="font-size: 1.5rem;">🛒</span>
                    <span>Добавить в корзину</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let categories = [];
    let products = [];
    let selectedCategory = null;
    let selectedProduct = null;
    let selectedSize = null;
    let currentImageIndex = 0;
    let searchTimeout = null;

    const tg = window.Telegram?.WebApp || {
        HapticFeedback: null,
        sendData: (data) => console.log('[v0] Telegram data:', data)
    };

    if (tg.ready) tg.ready();

    document.getElementById('searchInput').addEventListener('input', (e) => {
        const query = e.target.value.trim();
        clearTimeout(searchTimeout);

        if (query.length < 2) {
            document.getElementById('searchResults').classList.remove('active');
            return;
        }

        searchTimeout = setTimeout(() => searchProducts(query), 300);
    });

    async function searchProducts(query) {
        try {
            const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
            const results = await response.json();
            const container = document.getElementById('searchResults');

            if (results.length === 0) {
                container.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);"><div style="font-size: 2rem; margin-bottom: 0.5rem;">🔍</div><div style="font-weight: 600;">Ничего не найдено</div></div>';
            } else {
                container.innerHTML = results.map(product => `
                    <div class="search-result-item" onclick="showProduct(${product.id}); document.getElementById('searchResults').classList.remove('active'); document.getElementById('searchInput').blur();">
                        <img src="${product.photos[0] || '/static/placeholder.jpg'}" class="search-result-image" alt="${product.name}">
                        <div class="search-result-info">
                            <div class="search-result-name">${product.name}</div>
                            <div class="search-result-category">${product.category_name}</div>
                        </div>
                        <div class="search-result-price">${product.price} ₽</div>
                    </div>
                `).join('');
            }

            container.classList.add('active');
        } catch (error) {
            console.error('[v0] Search error:', error);
        }
    }

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-container')) {
            document.getElementById('searchResults').classList.remove('active');
        }
    });

    document.getElementById('sortFilter').addEventListener('change', applyFilters);
    document.getElementById('stockFilter').addEventListener('change', applyFilters);

    function applyFilters() {
        const sortValue = document.getElementById('sortFilter').value;
        const stockValue = document.getElementById('stockFilter').value;
        let filtered = [...products];

        if (stockValue === 'in_stock') {
            filtered = filtered.filter(p => p.stock > 0);
        } else if (stockValue === 'out_of_stock') {
            filtered = filtered.filter(p => p.stock === 0);
        }

        if (sortValue === 'price_asc') {
            filtered.sort((a, b) => a.price - b.price);
        } else if (sortValue === 'price_desc') {
            filtered.sort((a, b) => b.price - a.price);
        } else if (sortValue === 'name_asc') {
            filtered.sort((a, b) => a.name.localeCompare(b.name));
        } else if (sortValue === 'name_desc') {
            filtered.sort((a, b) => b.name.localeCompare(a.name));
        }

        displayProducts(filtered);
    }

    function displayProducts(productsToDisplay) {
        const container = document.getElementById('products');

        if (productsToDisplay.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-icon">📦</div><p class="empty-text">Товары отсутствуют</p></div>';
            return;
        }

        container.innerHTML = productsToDisplay.map(product => `
            <div class="product-card" onclick="showProduct(${product.id})">
                <div class="product-image-wrapper">
                    <img src="${product.photos[0] || '/static/placeholder.jpg'}" class="product-image" alt="${product.name}" loading="lazy">
                    ${product.stock === 0 ? '<div class="product-badge out-of-stock">Нет в наличии</div>' : product.stock < 5 ? '<div class="product-badge">Осталось мало</div>' : ''}
                </div>
                <div class="product-info">
                    <div class="product-name">${product.name}</div>
                    <div class="product-description">${product.description}</div>
                    <div class="product-footer">
                        <div class="product-price">${product.price} ₽</div>
                        <div class="product-stock ${product.stock === 0 ? 'out' : ''}">${product.stock > 0 ? `В наличии: ${product.stock}` : 'Нет в наличии'}</div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async function loadCategories() {
        try {
            const response = await fetch('/api/categories');
            categories = await response.json();
            const container = document.getElementById('categories');

            if (!categories || categories.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">📂</div><p class="empty-text">Категории отсутствуют. Администратор еще не добавил товары.</p></div>';
                document.getElementById('products').innerHTML = '<div class="empty-state"><div class="empty-icon">📦</div><p class="empty-text">Товары отсутствуют</p></div>';
                return;
            }

            container.innerHTML = categories.map((cat, index) => `
                <button class="category-btn ${index === 0 ? 'active' : ''}" onclick="selectCategory(${cat.id}, event)">
                    <span class="category-icon">${cat.icon || '📁'}</span>
                    <div class="category-name">${cat.name}</div>
                    <div class="category-count">${cat.product_count || 0} товаров</div>
                </button>
            `).join('');

            if (categories.length > 0) {
                loadProducts(categories[0].id);
            }
        } catch (error) {
            console.error('[v0] Error loading categories:', error);
            document.getElementById('categories').innerHTML = '<div class="empty-state"><div class="empty-icon">⚠️</div><p class="empty-text">Ошибка загрузки категорий. Попробуйте обновить страницу.</p></div>';
            document.getElementById('products').innerHTML = '<div class="empty-state"><div class="empty-icon">⚠️</div><p class="empty-text">Ошибка загрузки товаров</p></div>';
        }
    }

    function selectCategory(categoryId, event) {
        selectedCategory = categoryId;
        
        document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
        event.currentTarget.classList.add('active');
        
        if (tg.HapticFeedback) {
            tg.HapticFeedback.impactOccurred('light');
        }
        
        loadProducts(categoryId);
    }

    async function loadProducts(categoryId) {
        try {
            const container = document.getElementById('products');
            container.innerHTML = '<div class="empty-state"><div class="empty-icon">⏳</div><p class="empty-text">Загрузка товаров...</p></div>';

            const response = await fetch(`/api/products?category_id=${categoryId}`);
            products = await response.json();
            
            if (!products || products.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">📦</div><p class="empty-text">В этой категории пока нет товаров. Администратор скоро добавит новые товары.</p></div>';
                return;
            }
            
            applyFilters();
        } catch (error) {
            console.error('[v0] Error loading products:', error);
            document.getElementById('products').innerHTML = '<div class="empty-state"><div class="empty-icon">⚠️</div><p class="empty-text">Ошибка загрузки товаров. Попробуйте обновить страницу.</p></div>';
        }
    }

    async function showProduct(productId) {
        try {
            const response = await fetch(`/api/product/${productId}`);
            selectedProduct = await response.json();

            document.getElementById('modalProductName').textContent = selectedProduct.name;
            document.getElementById('modalProductDescription').textContent = selectedProduct.description;
            document.getElementById('modalProductPrice').textContent = `${selectedProduct.price} ₽`;
            
            const stockEl = document.getElementById('modalProductStock');
            if (selectedProduct.stock > 0) {
                stockEl.textContent = `✓ В наличии: ${selectedProduct.stock}`;
                stockEl.style.background = 'var(--success)';
                stockEl.style.color = 'white';
            } else {
                stockEl.textContent = '✗ Нет в наличии';
                stockEl.style.background = 'var(--error)';
                stockEl.style.color = 'white';
            }

            const photos = selectedProduct.photos.length > 0 ? selectedProduct.photos : ['/static/placeholder.jpg'];
            currentImageIndex = 0;

            document.getElementById('carouselImages').innerHTML = photos.map(photo => `
                <img src="${photo}" class="carousel-image" alt="${selectedProduct.name}">
            `).join('');

            document.getElementById('carouselIndicators').innerHTML = photos.map((_, index) => `
                <div class="carousel-indicator ${index === 0 ? 'active' : ''}" onclick="goToImage(${index}); event.stopPropagation();"></div>
            `).join('');

            const carouselBtns = document.querySelectorAll('.carousel-btn');
            carouselBtns.forEach(btn => {
                btn.style.display = photos.length > 1 ? 'flex' : 'none';
            });

            if (selectedProduct.sizes) {
                const sizes = JSON.parse(selectedProduct.sizes);
                document.getElementById('sizeSection').style.display = 'block';
                document.getElementById('sizeSelector').innerHTML = sizes.map(size => `
                    <button class="size-btn" onclick="selectSize('${size}'); event.stopPropagation();">${size}</button>
                `).join('');
                selectedSize = null;
            } else {
                document.getElementById('sizeSection').style.display = 'none';
                selectedSize = null;
            }

            document.getElementById('productModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('medium');
            }
        } catch (error) {
            console.error('[v0] Error loading product:', error);
            showToast('Ошибка загрузки товара', 'error');
        }
    }

    function nextImage() {
        const photos = selectedProduct.photos.length > 0 ? selectedProduct.photos : ['/static/placeholder.jpg'];
        currentImageIndex = (currentImageIndex + 1) % photos.length;
        updateCarousel();
        if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    }

    function prevImage() {
        const photos = selectedProduct.photos.length > 0 ? selectedProduct.photos : ['/static/placeholder.jpg'];
        currentImageIndex = (currentImageIndex - 1 + photos.length) % photos.length;
        updateCarousel();
        if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    }

    function goToImage(index) {
        currentImageIndex = index;
        updateCarousel();
        if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    }

    function updateCarousel() {
        const container = document.getElementById('carouselImages');
        container.style.transform = `translateX(-${currentImageIndex * 100}%)`;

        document.querySelectorAll('.carousel-indicator').forEach((indicator, index) => {
            indicator.classList.toggle('active', index === currentImageIndex);
        });
    }

    function selectSize(size) {
        selectedSize = size;
        document.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('selected'));
        event.target.classList.add('selected');
        if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    }

    function closeModal() {
        document.getElementById('productModal').classList.remove('active');
        document.body.style.overflow = '';
        selectedProduct = null;
        selectedSize = null;
    }

    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideIn 0.3s ease-out reverse';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function addToCart() {
        if (!selectedProduct) return;

        if (selectedProduct.stock === 0) {
            showToast('Товар отсутствует на складе', 'error');
            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
            return;
        }

        if (selectedProduct.sizes && !selectedSize) {
            showToast('Выберите размер', 'error');
            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('warning');
            return;
        }

        tg.sendData(JSON.stringify({
            action: 'add_to_cart',
            product_id: selectedProduct.id,
            size: selectedSize
        }));

        showToast('✓ Товар добавлен в корзину', 'success');
        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        closeModal();
    }

    loadCategories();
</script>
{% endblock %}
